(()=>{var e={917:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>o});var r=n(997);const o=new class{constructor(){this.characterName="",this.diceTitle=""}isBetaPage(){return window.location.href.includes("/beta/")}fetchCharacterName(){const e=Array.from(document.querySelectorAll(".small-text.grey-text.button-text")).find((e=>"Character Name"===e.textContent.trim()));if(!e)return null;const t=e.nextElementSibling;return t&&t.classList.contains("button-selection")?t.textContent.trim():null}fetchDiceTitle(){const e=document.getElementById("dice-title");return e?e.textContent.trim():""}extractCharacterData(e){const t=(0,r.sanitizeHTML)(e),n=document.createElement("div");return n.innerHTML=t,{name:this._extractName(n),level:this._extractLevel(n),traits:this._extractTraits(n),skills:this._extractSkills(n),...this._extractCombatStats(n),...this._extractAbilityScores(n),...this._extractInventoryAndSpells(n)}}_extractName(e){return(0,r.safeExtract)(e,".subtitle")||""}_extractLevel(e){return(0,r.safeExtract)(e,".item-level-box")||""}_extractTraits(e){return Array.from(e.querySelectorAll(".trait")).map((e=>e.textContent.trim()))}_extractSkills(e){return Array.from(e.querySelectorAll(".button-mystery")).map((e=>`${e.querySelector("b")?.textContent||""} ${e.querySelector("span")?.textContent||""}`.trim())).filter((e=>""!==e))}_extractCombatStats(e){return{ac:this._findStatValue(e,"AC"),hp:this._findStatValue(e,"HP"),fort:this._findSaveValue(e,"Fort"),ref:this._findSaveValue(e,"Ref"),will:this._findSaveValue(e,"Will"),speed:this._findStatValueWithPrefix(e,"Speed"),melee:this._findStatValueWithPrefix(e,"Melee"),ranged:this._findStatValueWithPrefix(e,"Ranged")}}_extractAbilityScores(e){const t=(e.textContent||"").match(/Str\s[+-]\d,\sDex\s[+-]\d,\sCon\s[+-]\d,\sInt\s[+-]\d,\sWis\s[+-]\d,\sCha\s[+-]\d/);return{abilities:t?t[0]:""}}_extractInventoryAndSpells(e){return{items:this._findStatValueWithPrefix(e,"Items"),spells:this._extractSpells(e)}}_findStatValue(e,t){const n=Array.from(e.querySelectorAll("b")).find((e=>e.textContent===t));return n?.nextElementSibling?.textContent.trim()||""}_findSaveValue(e,t){const n=Array.from(e.querySelectorAll(".button-mystery")).find((e=>e.textContent?.includes(t)));return n?.querySelector("span")?.textContent.trim()||""}_findStatValueWithPrefix(e,t){const n=Array.from(e.querySelectorAll("b")).find((e=>e.textContent===t));return n?.nextSibling?.nodeValue?.trim()||""}_extractSpells(e){const t=Array.from(e.querySelectorAll("b")).find((e=>e.textContent?.includes("Spells")));return t?t.parentNode.textContent.replace(t.textContent,"").trim():""}}},570:(e,t,n)=>{const{createExportButton:r}=n(920),{extractAndFormatTraits:o,removeElementsFromHtml:s}=n(997),i=n(917);e.exports=new class{constructor(){this.browser="undefined"!=typeof chrome?chrome:browser,this.diceHistoryObserver=null,this.sidebarObserver=null,this.contentObserver=null}addDetailExportButton(e){const t=e.querySelector(".listview-detail");if(!t||t.querySelector(".discord-export-button"))return;const n=r();n.addEventListener("click",(()=>this.handleExportClick(e))),t.appendChild(n)}prepareMessage(e,t,n){let r=t?`**${e}**\n> **Traits:** ${t}\n> ${n}`:`**${e}**\n> ${n}`;if((new TextEncoder).encode(r).length>1900){const o=1800-e.length-(t?t.length:0),s=n.substring(0,o);r=t?`**${e}**\n> **Traits:** ${t}\n> ${s}...\n> (Content truncated due to Discord's message limit)`:`**${e}**\n> ${s}...\n> (Content truncated due to Discord's message limit)`}return r}async handleExportClick(e){const t=e.querySelector(".listview-title")?.textContent.trim()||"",n=e.querySelector(".listview-detail"),{traits:r,traitDivs:i}=o(n),a=s(n.innerHTML,i),c=this.prepareMessage(t,r,a);try{const e=await this.browser.runtime.sendMessage({action:"sendToDiscord",message:c});"ok"!==e?.status&&console.error("Failed to send message:",e)}catch(e){console.error("Error sending message:",e)}}handleDynamicContent(){this.contentObserver&&this.contentObserver.disconnect(),this.contentObserver=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&(e.classList?.contains("listview-item")&&this.addDetailExportButton(e),e.querySelectorAll(".listview-item").forEach((e=>this.addDetailExportButton(e))))}))}))})),this.contentObserver.observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".listview-item").forEach((e=>{this.addDetailExportButton(e)}))}observeDiceHistory(){const e=document.getElementById("dice-history");e?(this.diceHistoryObserver&&this.diceHistoryObserver.disconnect(),this.diceHistoryObserver=new MutationObserver((e=>{e.forEach((e=>{if("childList"===e.type&&e.addedNodes.length>0){const t=e.addedNodes[0];t.nodeType===Node.ELEMENT_NODE&&this.handleDiceRoll(t)}}))})),this.diceHistoryObserver.observe(e,{childList:!0})):console.log("Dice history div not found")}async handleDiceRoll(e){const t=i.fetchCharacterName(),n=i.fetchDiceTitle(),r=e.textContent.trim();await this.browser.runtime.sendMessage({action:"sendToDiscord",message:`**${t||"Unknown Character"}** rolled ${n}: ${r}`})}cleanup(){this.diceHistoryObserver&&this.diceHistoryObserver.disconnect(),this.contentObserver&&this.contentObserver.disconnect(),this.sidebarObserver&&this.sidebarObserver.disconnect()}}},997:e=>{e.exports={convertHtmlToMarkdown:function(e){return e.replace(/<b>(.*?)<\/b>/g,"**$1**").replace(/<i>(.*?)<\/i>/g,"*$1*").replace(/<br\s*\/?>/g,"\n")},sanitizeHTML:function(e){const t=document.createElement("div");t.innerHTML=e;const n=t.getElementsByTagName("script");for(;n[0];)n[0].parentNode.removeChild(n[0]);const r=t.getElementsByTagName("*");for(let e=0;e<r.length;e++){const t=r[e].attributes;for(let n=t.length-1;n>=0;n--)t[n].name.startsWith("on")&&r[e].removeAttribute(t[n].name)}return t.innerHTML},formatListViewDetails:function(e){if(!e)return"";const t=e.split("\n").filter((e=>e.trim()));return t.length<=1?e:t[0]+"\n"+t.slice(1).map((e=>`> ${e}`)).join("\n")},removeElementsFromHtml:function(e,t){const n=document.createElement("div");return n.innerHTML=e,t.forEach((e=>{const t=e.tagName.toLowerCase()+Array.from(e.classList).map((e=>"."+e)).join(""),r=n.querySelector(t);r&&r.parentNode.removeChild(r)})),n.innerHTML},extractAndFormatTraits:function(e){const t=Array.from(e.querySelectorAll(".trait"));return{traits:[...new Set(t.map((e=>e.textContent.trim())))].map((e=>`**${e}**`)).join(" "),traitDivs:t}},safeExtract:function(e,t,n=0,r=""){const o=e.querySelectorAll(t);return o.length>n?o[n].textContent.trim():r}}},920:e=>{const t=new WeakMap;e.exports={showToast:function(e,t=3e3){let n=document.getElementById("alseta-toast-container");n||(n=document.createElement("div"),n.id="alseta-toast-container",n.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            right: 20px;\n            z-index: 9999;\n        ",document.body.appendChild(n));const r=document.createElement("div");r.className="alseta-toast",r.style.cssText="\n        background-color: #333;\n        color: white;\n        padding: 12px 24px;\n        border-radius: 4px;\n        margin-top: 10px;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n    ";const o=document.createElement("span");o.textContent=e,r.appendChild(o);const s=document.createElement("button");s.textContent="Ã—",s.className="close-btn",s.style.cssText="\n        background: none;\n        border: none;\n        color: white;\n        margin-left: 10px;\n        cursor: pointer;\n        font-size: 18px;\n    ",r.appendChild(s),n.appendChild(r);const i=()=>{r.remove(),0===n.children.length&&n.remove()};s.addEventListener("click",i),setTimeout(i,t)},createExportButton:function(){const e=document.createElement("button");return e.textContent="Send To Discord",e.className="discord-export-button",Object.assign(e.style,{backgroundColor:"#4CAF50",color:"white",border:"none",padding:"8px 16px",borderRadius:"4px",cursor:"pointer",marginTop:"10px"}),e},hasEventListener:function(e,n){const r=t.get(e);return!!r&&r.has(n)},registerEventListener:function(e,n){t.has(e)||t.set(e,new Set),t.get(e).add(n)},eventListenerRegistry:t,injectCSS:function(e){if(!e)return;const t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href="undefined"!=typeof browser&&browser.runtime?browser.runtime.getURL(e):new URL(e,window.location.href).href,document.head.appendChild(t)},setupLogging:function(){const e=console.log;console.log=(...t)=>{e("Alseta's Passage Log:",": ",...t)}}}}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e=n(920),t=n(570),r=n.n(t);const o=console.log;function s(){r().initializeObservers(),r().setupMutationObserver(),r().handleDynamicContent()}console.log=function(...e){o("Alseta's Passage Log:",...e)},document.addEventListener("DOMContentLoaded",(()=>{(0,e.injectCSS)(chrome.runtime.getURL("toast.css")),s()})),window.addEventListener("load",s)})()})();