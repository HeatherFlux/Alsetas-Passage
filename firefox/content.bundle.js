(()=>{"use strict";const e=new WeakMap;function t(e,t=3e3){let r=document.getElementById("alseta-toast-container");r||(r=document.createElement("div"),r.id="alseta-toast-container",document.body.appendChild(r));const n=document.createElement("div");n.className="alseta-toast";const i=document.createTextNode(e);n.appendChild(i);const s=document.createElement("span");s.className="close-btn",s.textContent="Ã—",s.addEventListener("click",(()=>{n.classList.remove("show"),setTimeout((()=>n.remove()),500)})),n.appendChild(s),r.appendChild(n),setTimeout((()=>n.classList.add("show")),10),setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>n.remove()),500)}),t)}function r(t,r){return e.has(t)&&e.get(t).includes(r)}function n(e,t,r=0,n=""){const i=e.querySelectorAll(t);return i.length>r?i[r].innerText.trim():n}function i(e,t){return t.forEach((t=>{e=e.replace(t.outerHTML,"")})),e}const s=new class{constructor(){this.characterName="",this.diceTitle=""}isBetaPage(){return window.location.href.includes("/beta/")}fetchCharacterName(){const e=Array.from(document.querySelectorAll(".small-text.grey-text.button-text")).find((e=>"Character Name"===e.textContent.trim()));if(e){const t=e.nextElementSibling;if(t&&t.classList.contains("button-selection"))return t.textContent}return null}fetchDiceTitle(){const e=document.getElementById("dice-title");return e?e.textContent:""}extractCharacterData(e){const t=function(e){const t=document.createElement("div");t.innerHTML=e;const r=t.getElementsByTagName("script");for(;r.length>0;)r[0].parentNode.removeChild(r[0]);const n=t.getElementsByTagName("*");for(let e=0;e<n.length;e++){const t=n[e].attributes;for(let r=t.length-1;r>=0;r--)t[r].name.startsWith("on")&&n[e].removeAttribute(t[r].name)}return t.innerHTML}(e),r=document.createElement("div");return r.innerHTML=t,{name:n(r,".subtitle",0),level:n(r,".item-level-box",0),traits:this._extractTraits(r),skills:this._extractSkills(r),...this._extractCombatStats(r),...this._extractAbilityScores(r),...this._extractInventoryAndSpells(r),...this._extractLoreAndKnowledge(r)}}_extractTraits(e){return Array.from(e.querySelectorAll(".trait")).map((e=>e.innerText.trim()))}_extractSkills(e){return Array.from(e.querySelectorAll(".button-mystery")).map((e=>`${e.querySelector("b")?.innerText||""} ${e.querySelector("span")?.innerText||""}`.trim()))}_extractCombatStats(e){return{ac:this._findStatValue(e,"AC"),hp:this._findStatValue(e,"HP"),fort:this._findSaveValue(e,"Fort"),ref:this._findSaveValue(e,"Ref"),will:this._findSaveValue(e,"Will"),speed:this._findStatValueWithPrefix(e,"Speed"),melee:this._findStatValueWithPrefix(e,"Melee"),ranged:this._findStatValueWithPrefix(e,"Ranged")}}_extractAbilityScores(e){const t=e.innerText.match(/Str\s[+-]\d,\sDex\s[+-]\d,\sCon\s[+-]\d,\sInt\s[+-]\d,\sWis\s[+-]\d,\sCha\s[+-]\d/);return{abilities:t?t[0]:""}}_extractInventoryAndSpells(e){return{items:this._findStatValueWithPrefix(e,"Items"),spells:this._extractSpells(e)}}_extractLoreAndKnowledge(e){const t=e.querySelectorAll("b");return{recallKnowledge:t[0]?.nextSibling?.nodeValue?.trim()||"",unspecificLore:t[1]?.nextSibling?.nodeValue?.trim()||"",specificLore:t[2]?.nextSibling?.nodeValue?.trim()||""}}_findStatValue(e,t){const r=Array.from(e.querySelectorAll("b")).find((e=>e.innerText===t));return r?.nextElementSibling?.innerText.trim()||""}_findSaveValue(e,t){const r=Array.from(e.querySelectorAll(".button-mystery")).find((e=>e.innerText.includes(t)));return r?.querySelector("span")?.innerText.trim()||""}_findStatValueWithPrefix(e,t){const r=Array.from(e.querySelectorAll("b")).find((e=>e.innerText===t));return r?.nextSibling?.nodeValue.trim()||""}_extractSpells(e){const t=Array.from(e.querySelectorAll("b")).find((e=>e.innerText.includes("Spells")));return t?t.parentNode.innerText.replace(t.innerText,"").trim():""}},o=new class{constructor(){this.observers=new Set,this.setupMessageHandling()}cleanup(){this.observers.forEach((e=>e.disconnect())),this.observers.clear()}trackObserver(e){this.observers.add(e)}setupMessageHandling(){this.sendToDiscord=async e=>{try{console.log("Attempting to send message to Discord. Size:",(new TextEncoder).encode(e).length,"bytes");const r=await browser.runtime.sendMessage({action:"sendToDiscord",message:e});if("ok"!==r?.status){const n=r?.message||"Unknown error",i=r?.details||{};t(`Error sending to Discord: ${n}`),console.error("Failed to send message to background script:",{response:r,error:n,messageSize:i.messageSize||(new TextEncoder).encode(e).length,messagePreview:i.messagePreview||e.substring(0,100)+"..."})}}catch(r){t(`Error sending to Discord: ${r.message||"Unknown error"}`),console.error("Error sending message to background script:",{error:r.message,stack:r.stack,messageSize:(new TextEncoder).encode(e).length,messagePreview:e.substring(0,100)+"..."})}}}addDetailExportButton(t){let n=t.querySelector(".listview-detail");if(n&&""===n.innerHTML.trim()&&(n=n.nextElementSibling),!n)return;let i=n.querySelector(".discord-export-button");var s;i&&r(i,"click")||(i||(i=function(){const e=document.createElement("button");return e.textContent="Send To Discord",e.className="discord-export-button",Object.assign(e.style,{fontSize:"12px",marginBottom:"10px",padding:"2px 5px",display:"inline-block",verticalAlign:"middle",backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",width:"auto"}),e}(),n.insertBefore(i,n.firstChild)),r(i,"click")||(i.addEventListener("click",(e=>this.handleButtonClick(e,t))),s=i,e.has(s)||e.set(s,[]),e.get(s).push("click")))}async handleButtonClick(e,t){e.stopPropagation();let r=t.querySelector(".listview-detail");if(r&&""===r.innerHTML.trim()&&(r=r.nextElementSibling),!r)return void console.error("No detailDiv found for",t);const n=t.querySelector(".listview-title"),s=n&&n.innerText?n.innerText.trim():"Untitled",{traits:o,traitDivs:a}=function(e){const t=e.querySelectorAll(".trait");return{traits:Array.from(new Set(Array.from(t).map((e=>`**${e.innerText}**`)))).join(" "),traitDivs:t}}(r),c=o?o.trim():"";let l=r.innerHTML;l=i(l,a);const d=t.querySelector(".discord-export-button");d&&(l=i(l,[d]));const u=function(e){let t=e;return t=t.replace(/<b>(.*?)<\/b>/g,"**$1**").replace(/<i>(.*?)<\/i>/g,"*$1*").replace(/<br\s*\/?>/g,"\n").replace(/<[^>]+>/g,"\n"),t.trim()}(l).trim(),m=this.prepareMessage(s||"Untitled",c,u);await this.sendToDiscord(m)}prepareMessage(e,t,r){const n=r.replace(/\n+/g,"\n> ").trim();let i=t?`**${e}**\n> **Traits:** ${t}\n> ${n}`:`**${e}**\n> ${n}`;if((new TextEncoder).encode(i).length>1900){const r=1800-e.length-(t?t.length:0),s=n.substring(0,r);i=t?`**${e}**\n> **Traits:** ${t}\n> ${s}...\n> (Content truncated due to Discord's message limit)`:`**${e}**\n> ${s}...\n> (Content truncated due to Discord's message limit)`}return i}initialize(){this.cleanup(),this.observeDiceHistory(),this.observeSidebar(),this.setupMutationObserver()}handleDynamicContent(){this.initialize(),document.querySelectorAll(".listview-item, .div-info-lm-box").forEach((e=>{this.addDetailExportButton(e),this.setupContainerClickListener(e)}))}setupContainerClickListener(e){e.addEventListener("click",(()=>{setTimeout((()=>{let t=e.querySelector(".listview-detail");t&&""===t.innerHTML.trim()&&(t=t.nextElementSibling),t&&(t.classList.toggle("hidden"),t.classList.contains("hidden")||this.addDetailExportButton(e))}),500)}))}observeDiceHistory(){const e=document.getElementById("dice-history");if(!e)return void console.log("Dice history div not found");const t=new MutationObserver((()=>this.logDiceHistory()));this.trackObserver(t),t.observe(e,{childList:!0})}async logDiceHistory(){try{const e=document.getElementById("dice-history");if(!e)return;const t=e.firstElementChild;if(!t)throw new Error("No History Found");const r=s.fetchDiceTitle(),n=s.fetchCharacterName()||s.characterName||"Unknown Character";await browser.runtime.sendMessage({action:"logCharacterName",data:n,history:t.innerHTML,title:r||"Roll"})}catch(e){console.error("Error logging dice history:",e)}}observeSidebar(){const e=document.querySelector(".dice-tray");if(!e)return;const t=new MutationObserver((()=>{s.fetchDiceTitle();const e=s.fetchCharacterName();e&&(s.characterName=e)}));this.trackObserver(t),t.observe(e,{childList:!0,subtree:!0})}setupMutationObserver(){const e=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{1===e.nodeType&&(e.matches(".listview-item, .div-info-lm-box")?(this.addDetailExportButton(e),this.setupContainerClickListener(e)):e.querySelectorAll(".listview-item, .div-info-lm-box").forEach((e=>{this.addDetailExportButton(e),this.setupContainerClickListener(e)})))}))}))}));this.trackObserver(e),e.observe(document.body,{childList:!0,subtree:!0})}};function a(){console.log("Injecting Resources"),function(){const e=document.createElement("link");e.href=browser.runtime.getURL("toast.css"),e.rel="stylesheet",document.head.appendChild(e)}(),console.log("Resources Injected"),console.log("Starting Observers"),o.handleDynamicContent(),console.log("Observers Started")}!function(){const e=console.log;console.log=function(){var t=Array.from(arguments);t.unshift("Alseta's Passage Log:: "),e.apply(console,t)}}();let c=null;a(),c&&c.disconnect(),c=new MutationObserver((e=>{e.some((e=>Array.from(e.addedNodes).some((e=>1===e.nodeType&&(e.matches(".dice-tray, #dice-history")||e.querySelector(".dice-tray, #dice-history"))))))&&(console.log("Significant DOM changes detected, reinitializing extension."),a())})),c.observe(document.body,{childList:!0,subtree:!0}),browser.webNavigation.onCompleted.addListener((e=>{0===e.frameId&&(console.log("WebNavigation completed, re-initializing extension."),a())}),{url:[{hostContains:"pathbuilder"}]})})();