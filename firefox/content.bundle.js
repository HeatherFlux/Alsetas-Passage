(()=>{"use strict";const e=new WeakMap;function t(e,t=3e3){let n=document.getElementById("alseta-toast-container");n||(n=document.createElement("div"),n.id="alseta-toast-container",document.body.appendChild(n));const r=document.createElement("div");r.className="alseta-toast";const o=document.createTextNode(e);r.appendChild(o);const i=document.createElement("span");i.className="close-btn",i.textContent="Ã—",i.addEventListener("click",(()=>{r.classList.remove("show"),setTimeout((()=>r.remove()),500)})),r.appendChild(i),n.appendChild(r),setTimeout((()=>r.classList.add("show")),10),setTimeout((()=>{r.classList.remove("show"),setTimeout((()=>r.remove()),500)}),t)}function n(t,n){return e.has(t)&&e.get(t).includes(n)}function r(e,t,n=0,r=""){const o=e.querySelectorAll(t);return o.length>n?o[n].innerText.trim():r}function o(e,t){return t.forEach((t=>{e=e.replace(t.outerHTML,"")})),e}const i=new class{constructor(){this.characterName="",this.diceTitle=""}isBetaPage(){return window.location.href.includes("/beta/")}fetchCharacterName(){const e=Array.from(document.querySelectorAll(".small-text.grey-text.button-text")).find((e=>"Character Name"===e.textContent.trim()));if(e){const t=e.nextElementSibling;if(t&&t.classList.contains("button-selection"))return t.textContent}return null}fetchDiceTitle(){const e=document.getElementById("dice-title");return e?e.textContent:""}extractCharacterData(e){const t=function(e){const t=document.createElement("div");t.innerHTML=e;const n=t.getElementsByTagName("script");for(;n.length>0;)n[0].parentNode.removeChild(n[0]);const r=t.getElementsByTagName("*");for(let e=0;e<r.length;e++){const t=r[e].attributes;for(let n=t.length-1;n>=0;n--)t[n].name.startsWith("on")&&r[e].removeAttribute(t[n].name)}return t.innerHTML}(e),n=document.createElement("div");return n.innerHTML=t,{name:r(n,".subtitle",0),level:r(n,".item-level-box",0),traits:this._extractTraits(n),skills:this._extractSkills(n),...this._extractCombatStats(n),...this._extractAbilityScores(n),...this._extractInventoryAndSpells(n),...this._extractLoreAndKnowledge(n)}}_extractTraits(e){return Array.from(e.querySelectorAll(".trait")).map((e=>e.innerText.trim()))}_extractSkills(e){return Array.from(e.querySelectorAll(".button-mystery")).map((e=>`${e.querySelector("b")?.innerText||""} ${e.querySelector("span")?.innerText||""}`.trim()))}_extractCombatStats(e){return{ac:this._findStatValue(e,"AC"),hp:this._findStatValue(e,"HP"),fort:this._findSaveValue(e,"Fort"),ref:this._findSaveValue(e,"Ref"),will:this._findSaveValue(e,"Will"),speed:this._findStatValueWithPrefix(e,"Speed"),melee:this._findStatValueWithPrefix(e,"Melee"),ranged:this._findStatValueWithPrefix(e,"Ranged")}}_extractAbilityScores(e){const t=e.innerText.match(/Str\s[+-]\d,\sDex\s[+-]\d,\sCon\s[+-]\d,\sInt\s[+-]\d,\sWis\s[+-]\d,\sCha\s[+-]\d/);return{abilities:t?t[0]:""}}_extractInventoryAndSpells(e){return{items:this._findStatValueWithPrefix(e,"Items"),spells:this._extractSpells(e)}}_extractLoreAndKnowledge(e){const t=e.querySelectorAll("b");return{recallKnowledge:t[0]?.nextSibling?.nodeValue?.trim()||"",unspecificLore:t[1]?.nextSibling?.nodeValue?.trim()||"",specificLore:t[2]?.nextSibling?.nodeValue?.trim()||""}}_findStatValue(e,t){const n=Array.from(e.querySelectorAll("b")).find((e=>e.innerText===t));return n?.nextElementSibling?.innerText.trim()||""}_findSaveValue(e,t){const n=Array.from(e.querySelectorAll(".button-mystery")).find((e=>e.innerText.includes(t)));return n?.querySelector("span")?.innerText.trim()||""}_findStatValueWithPrefix(e,t){const n=Array.from(e.querySelectorAll("b")).find((e=>e.innerText===t));return n?.nextSibling?.nodeValue.trim()||""}_extractSpells(e){const t=Array.from(e.querySelectorAll("b")).find((e=>e.innerText.includes("Spells")));return t?t.parentNode.innerText.replace(t.innerText,"").trim():""}},s=new class{constructor(){this.observers=new Set,this.setupMessageHandling()}cleanup(){this.observers.forEach((e=>e.disconnect())),this.observers.clear()}trackObserver(e){this.observers.add(e)}setupMessageHandling(){this.sendToDiscord=async e=>{try{console.log("Attempting to send message to Discord. Size:",(new TextEncoder).encode(e).length,"bytes");const n=await browser.runtime.sendMessage({action:"sendToDiscord",message:e});if("ok"!==n?.status){const r=n?.message||"Unknown error",o=n?.details||{};t(`Error sending to Discord: ${r}`),console.error("Failed to send message to background script:",{response:n,error:r,messageSize:o.messageSize||(new TextEncoder).encode(e).length,messagePreview:o.messagePreview||e.substring(0,100)+"..."})}}catch(n){t(`Error sending to Discord: ${n.message||"Unknown error"}`),console.error("Error sending message to background script:",{error:n.message,stack:n.stack,messageSize:(new TextEncoder).encode(e).length,messagePreview:e.substring(0,100)+"..."})}}}addDetailExportButton(t){let r=t.querySelector(".listview-detail");if(r&&""===r.innerHTML.trim()&&(r=r.nextElementSibling),!r)return;let o=r.querySelector(".discord-export-button");var i;o&&n(o,"click")||(o||(o=function(){const e=document.createElement("button");return e.textContent="Send To Discord",e.className="discord-export-button",Object.assign(e.style,{fontSize:"12px",marginBottom:"10px",padding:"2px 5px",display:"inline-block",verticalAlign:"middle",backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",width:"auto"}),e}(),r.insertBefore(o,r.firstChild)),n(o,"click")||(o.addEventListener("click",(e=>this.handleButtonClick(e,t))),i=o,e.has(i)||e.set(i,[]),e.get(i).push("click")))}async handleButtonClick(e,t){e.stopPropagation();let n=t.querySelector(".listview-detail");if(n&&""===n.innerHTML.trim()&&(n=n.nextElementSibling),!n)return void console.error("No detailDiv found for",t);const r=t.querySelector(".listview-title"),i=r&&r.innerText?r.innerText.trim():"Untitled",{traits:s,traitDivs:c}=function(e){const t=e.querySelectorAll(".trait");return{traits:Array.from(new Set(Array.from(t).map((e=>`**${e.innerText}**`)))).join(" "),traitDivs:t}}(n),a=s?s.trim():"";let l=n.innerHTML;l=o(l,c);const d=t.querySelector(".discord-export-button");d&&(l=o(l,[d]));const u=function(e){let t=e;return t=t.replace(/<b>(.*?)<\/b>/g,"**$1**").replace(/<i>(.*?)<\/i>/g,"*$1*").replace(/<br\s*\/?>/g,"\n").replace(/<[^>]+>/g,"\n"),t.trim()}(l).trim(),m=this.prepareMessage(i||"Untitled",a,u);await this.sendToDiscord(m)}prepareMessage(e,t,n){const r=n.replace(/\n+/g,"\n> ").trim();let o=t?`**${e}**\n> **Traits:** ${t}\n> ${r}`:`**${e}**\n> ${r}`;if((new TextEncoder).encode(o).length>1900){const n=1800-e.length-(t?t.length:0),i=r.substring(0,n);o=t?`**${e}**\n> **Traits:** ${t}\n> ${i}...\n> (Content truncated due to Discord's message limit)`:`**${e}**\n> ${i}...\n> (Content truncated due to Discord's message limit)`}return o}initialize(){this.cleanup(),this.observeDiceHistory(),this.observeSidebar(),this.observeStatBlock(),this.setupMutationObserver()}handleDynamicContent(){this.initialize(),document.querySelectorAll(".listview-item, .div-info-lm-box").forEach((e=>{this.addDetailExportButton(e),this.setupContainerClickListener(e)}))}setupContainerClickListener(e){e.addEventListener("click",(()=>{setTimeout((()=>{let t=e.querySelector(".listview-detail");t&&""===t.innerHTML.trim()&&(t=t.nextElementSibling),t&&(t.classList.toggle("hidden"),t.classList.contains("hidden")||this.addDetailExportButton(e))}),500)}))}observeDiceHistory(){const e=document.getElementById("dice-history");if(!e)return void console.log("Dice history div not found");const t=new MutationObserver((()=>this.logDiceHistory()));this.trackObserver(t),t.observe(e,{childList:!0})}async logDiceHistory(){try{const e=document.getElementById("dice-history");if(!e)return;const t=e.firstElementChild;if(!t)throw new Error("No History Found");const n=i.fetchDiceTitle();let r=i.fetchCharacterName()||i.characterName;this.activeMonsterName?(console.log("Using active monster name for roll:",this.activeMonsterName),r=this.activeMonsterName):r=r||"Unknown Character",await browser.runtime.sendMessage({action:"logCharacterName",data:r,history:t.innerHTML,title:n||"Roll"})}catch(e){console.error("Error logging dice history:",e)}}observeSidebar(){const e=document.querySelector(".dice-tray");if(!e)return;const t=new MutationObserver((()=>{i.fetchDiceTitle();const e=i.fetchCharacterName();e&&(i.characterName=e)}));this.trackObserver(t),t.observe(e,{childList:!0,subtree:!0})}observeStatBlock(){console.log("Starting observeStatBlock");const e=document.querySelector(".div-statblock");if(console.log("Found stat block?",!!e),!e)return void console.log("Stat block not found, skipping observer setup");let t="";const n=e.querySelector(".subtitle");console.log("Found subtitle?",!!n,"Content:",n?.textContent),n&&(t=n.textContent.trim(),this.currentMonsterName=t,console.log("Initial monster name:",t));const r=e.querySelectorAll(".dice-button");console.log("Initial dice buttons found:",r.length),r.forEach((e=>{e.hasClickListener||(e.hasClickListener=!0,e.addEventListener("click",(()=>{console.log("Dice button clicked for monster:",this.currentMonsterName),this.activeMonsterName=this.currentMonsterName})),console.log("Added click listener to button"))}));const o=new MutationObserver((t=>{console.log("Stat block changed, processing",t.length,"mutations");for(const n of t){const t=e.querySelectorAll(".dice-button:not([data-has-listener])");t.length>0&&(console.log("Found",t.length,"new dice buttons"),t.forEach((e=>{e.dataset.hasListener="true",e.addEventListener("click",(()=>{console.log("New dice button clicked for monster:",this.currentMonsterName),this.activeMonsterName=this.currentMonsterName}))})));const n=e.querySelector(".subtitle");if(n){const e=n.textContent.trim();e!==this.currentMonsterName&&(console.log("Monster name changed from",this.currentMonsterName,"to",e),this.currentMonsterName=e)}}}));console.log("Setting up mutation observer"),this.trackObserver(o),o.observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0}),console.log("Stat block observer setup complete")}setupMutationObserver(){const e=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{1===e.nodeType&&(e.matches(".listview-item, .div-info-lm-box")?(this.addDetailExportButton(e),this.setupContainerClickListener(e)):e.querySelectorAll(".listview-item, .div-info-lm-box").forEach((e=>{this.addDetailExportButton(e),this.setupContainerClickListener(e)})))}))}))}));this.trackObserver(e),e.observe(document.body,{childList:!0,subtree:!0})}};function c(){console.log("Injecting Resources"),function(){const e=document.createElement("link");e.href=browser.runtime.getURL("toast.css"),e.rel="stylesheet",document.head.appendChild(e)}(),console.log("Resources Injected"),console.log("Starting Observers"),s.handleDynamicContent(),console.log("Observers Started")}!function(){const e=console.log;console.log=function(){var t=Array.from(arguments);t.unshift("Alseta's Passage Log:: "),e.apply(console,t)}}();let a=null;c(),a&&a.disconnect(),a=new MutationObserver((e=>{e.some((e=>Array.from(e.addedNodes).some((e=>1===e.nodeType&&(e.matches(".dice-tray, #dice-history")||e.querySelector(".dice-tray, #dice-history"))))))&&(console.log("Significant DOM changes detected, reinitializing extension."),c())})),a.observe(document.body,{childList:!0,subtree:!0}),browser.webNavigation.onCompleted.addListener((e=>{0===e.frameId&&(console.log("WebNavigation completed, re-initializing extension."),c())}),{url:[{hostContains:"pathbuilder"}]})})();